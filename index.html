<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change and Geographic Preferences</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            width: 100%;
            margin: 0;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .controls {
            padding: 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-primary.active {
            background: #27ae60;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
            font-size: 16px;
            padding: 12px 30px;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .mode-indicator {
            padding: 8px 16px;
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 4px;
            font-size: 13px;
            color: #155724;
        }
        
        .map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            flex: 1;
        }
        
        .info-box {
            padding: 20px;
            background: #e8f4f8;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .spray-cursor {
            cursor: crosshair !important;
        }
        
        .spray-cursor * {
            cursor: crosshair !important;
        }
        
        .spray-point {
            border-radius: 50%;
            background: rgba(39, 174, 96, 0.6);
            border: 2px solid rgba(34, 153, 84, 0.8);
        }
        
        /* Tutorial styles */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tutorial-modal {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .tutorial-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }
        
        .tutorial-header h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .tutorial-header p {
            margin: 0;
            opacity: 0.95;
            font-size: 16px;
        }
        
        .tutorial-content {
            padding: 30px;
        }
        
        .tutorial-step {
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
        }
        
        .tutorial-step:last-child {
            margin-bottom: 0;
        }
        
        .step-number {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .step-content h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .step-content p {
            margin: 0;
            color: #5a6c7d;
            line-height: 1.6;
        }
        
        .tutorial-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
        }
        
        .tutorial-skip {
            color: #7f8c8d;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .tutorial-skip:hover {
            color: #5a6c7d;
        }
        
        .btn-tutorial {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-tutorial:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Label tooltips */
        .state-label-tooltip {
            background: rgba(44, 62, 80, 0.9) !important;
            border: none !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
            color: white !important;
            font-weight: 600 !important;
            font-size: 13px !important;
            padding: 6px 12px !important;
            pointer-events: none !important;
        }
        
        .county-label-tooltip {
            background: rgba(52, 73, 94, 0.9) !important;
            border: none !important;
            border-radius: 3px !important;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;
            color: white !important;
            font-weight: 500 !important;
            font-size: 11px !important;
            padding: 4px 8px !important;
            pointer-events: none !important;
        }
        
        .success-message {
            display: none;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            color: #155724;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .success-message.show {
            display: block;
        }
        
        /* Zoom hint overlay */
        .zoom-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .zoom-hint.show {
            opacity: 1;
        }
        
        .zoom-hint-key {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 3px;
        }
    </style>
</head>
<body>
    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-modal">
            <div class="tutorial-header">
                <p>Please follow these instructions to annotate this map of the United States. You will use an annotation tool to mark areas you view as safe and desirable places to live, taking climate change-related concerns into account.</p>
            </div>
            
            <div class="tutorial-content">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Use the Annotation Tool to Mark Desired Areas</h3>
                        <p>The annotation tool starts enabled (ON). Hold down your mouse button and drag across areas you'd like to mark.</p>
                        <p style="margin-top: 8px;"><strong>Toggle the annotation tool ON/OFF</strong> using the button at the top. Turn it OFF to navigate and zoom without adding marks, then turn it back ON to continue spraying.</p>
                    </div>
                </div>
                
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Zoom to Adjust Precision</h3>
                        <p><strong>To zoom:</strong> Hold Ctrl (or ⌘ on Mac) and scroll with your mouse or trackpad. You can also use the +/- buttons on the map.</p>
                        <p style="margin-top: 8px;"><strong>Zoom out</strong> to mark broad regions quickly (the tool covers larger areas).</p>
                        <p style="margin-top: 8px;"><strong>Zoom in</strong> for precise areas like specific neighborhoods or cities (the tool becomes more focused).</p>
                        <p style="margin-top: 8px;">The annotation tool automatically adjusts its radius based on your zoom level.</p>
                    </div>
                </div>
                
                
                
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>Review and Submit</h3>
                        <p>Check the counter at the bottom to see how many points you've marked. Use the "Undo Last Annotation" button to remove your most recent marks.</p>
                        <p style="margin-top: 8px;">When you're done, click "Submit My Selections" to continue with the survey. Need to start over? Use the "Clear All" button.</p>
                    </div>
                </div>
            </div>
            
            <div class="tutorial-footer">
                <button class="btn-tutorial" id="tutorialStart">Start</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>Climate Change and Geographic Preferences</h1>
            <p>Please mark areas you view as safe and desirable places to live given climate change considerations.</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button class="btn btn-primary active" id="sprayToggle">
                    Annotation Tool: ON
                </button>
                
                <button class="btn btn-secondary" id="undoBtn" disabled>
                    ↶ Undo Last Annotation
                </button>
                
                <button class="btn btn-secondary" id="clearAll">Clear All</button>
                
                <button class="btn btn-secondary" id="helpBtn" title="Show tutorial">
                    ❓ Help
                </button>
                
                <div class="mode-indicator" id="sprayInfo">
                    Spray radius: <span id="sprayRadius">50</span>km | Hold mouse/touch to spray | Hold Ctrl (⌘ on Mac) + scroll to zoom
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="zoom-hint" id="zoomHint">
                Hold <span class="zoom-hint-key">Ctrl</span> (or <span class="zoom-hint-key">⌘</span>) + scroll to zoom
            </div>
            
            <div class="info-box">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="sprayCount">0</div>
                        <div class="stat-label">Points Marked</div>
                    </div>
                </div>
                
                <button class="btn btn-success" id="submitBtn" style="width: 100%;">
                    Submit My Selections
                </button>
                
                <div class="success-message" id="successMessage">
                    ✓ Your selections have been saved! You can now continue with the survey.
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Check if we're in an iframe (embedded in Qualtrics)
        const isEmbedded = window.self !== window.top;
        
        // Initialize the map
        const map = L.map('map').setView([39.8283, -98.5795], 5);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 20
        }).addTo(map);
        
        let selectionData = {
            sprayedPoints: []
        };
        
        // Track spray sessions for undo functionality
        let spraySessions = []; // Each session is an array of points added during one click-and-drag
        let currentSession = null;
        let sprayPointLayers = []; // Keep references to Leaflet layers for removal
        
        let stateLayer = null;
        let countyLayer = null;
        let sprayLayer = new L.FeatureGroup();
        map.addLayer(sprayLayer);
        
        let isSpraying = false;
        let sprayEnabled = true; // Track whether spray tool is active
        
        map.dragging.disable();
        
        // Disable default scroll zoom
        map.scrollWheelZoom.disable();
        
        // Add custom scroll zoom that requires Ctrl/Cmd key
        let zoomHintTimeout = null;
        
        map.on('wheel', function(e) {
            // Only zoom if Ctrl (Windows/Linux) or Cmd (Mac) key is pressed
            if (e.originalEvent.ctrlKey || e.originalEvent.metaKey) {
                e.originalEvent.preventDefault();
                
                // Hide hint if visible
                document.getElementById('zoomHint').classList.remove('show');
                
                // Determine zoom direction
                const delta = e.originalEvent.deltaY;
                if (delta < 0) {
                    map.zoomIn();
                } else {
                    map.zoomOut();
                }
            } else {
                // Show hint when user tries to scroll without modifier
                const hint = document.getElementById('zoomHint');
                hint.classList.add('show');
                
                // Clear previous timeout
                if (zoomHintTimeout) {
                    clearTimeout(zoomHintTimeout);
                }
                
                // Hide hint after 2 seconds
                zoomHintTimeout = setTimeout(function() {
                    hint.classList.remove('show');
                }, 2000);
            }
            // If no modifier key, allow normal page scrolling (don't preventDefault)
        });
        
        map.getContainer().classList.add('spray-cursor');
        
        async function loadStates() {
            const response = await fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json');
            const data = await response.json();
            
            const lower48 = ['Alabama', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 
                           'Delaware', 'Florida', 'Georgia', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 
                           'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 
                           'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 
                           'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico', 'New York', 
                           'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 
                           'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 
                           'Vermont', 'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'];
            
            data.features = data.features.filter(feature => 
                lower48.includes(feature.properties.name)
            );
            
            stateLayer = L.geoJSON(data, {
                style: function(feature) {
                    return {
                        fillColor: 'transparent',
                        weight: 2,
                        opacity: 0.3,
                        color: '#95a5a6',
                        fillOpacity: 0,
                        interactive: false
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.bindTooltip(feature.properties.name, {
                        permanent: false,
                        direction: 'center',
                        className: 'state-label-tooltip'
                    });
                }
            }).addTo(map);
        }
        
        async function loadCounties() {
            const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
            const data = await response.json();
            
            data.features = data.features.filter(feature => {
                const fips = feature.id;
                const stateCode = fips.substring(0, 2);
                return stateCode !== '02' && stateCode !== '15';
            });
            
            countyLayer = L.geoJSON(data, {
                style: function(feature) {
                    return {
                        fillColor: 'transparent',
                        weight: 1,
                        opacity: 0.2,
                        color: '#bdc3c7',
                        fillOpacity: 0,
                        interactive: false
                    };
                },
                onEachFeature: function(feature, layer) {
                    const countyName = feature.properties.NAME || 'Unknown';
                    layer.bindTooltip(countyName, {
                        permanent: false,
                        direction: 'center',
                        className: 'county-label-tooltip'
                    });
                }
            }).addTo(map);
        }
        
        function updateDisplay() {
            document.getElementById('sprayCount').textContent = selectionData.sprayedPoints.length;
        }
        
        function clearAllSelections() {
            selectionData = {
                sprayedPoints: []
            };
            sprayLayer.clearLayers();
            sprayPointLayers = [];
            spraySessions = [];
            currentSession = null;
            document.getElementById('undoBtn').disabled = true;
            updateDisplay();
        }
        
        function getSprayRadius() {
            const zoom = map.getZoom();
            const baseRadius = 100000;
            const zoomFactor = Math.pow(0.5, zoom - 4);
            return Math.max(250, baseRadius * zoomFactor);
        }
        
        function getSprayPointSize() {
            const zoom = map.getZoom();
            return Math.max(4, 15 - zoom * 0.75);
        }
        
        function sprayPoint(latlng) {
            const radius = getSprayRadius();
            const pointSize = getSprayPointSize();
            
            const randomOffset = radius * 0.3;
            const randomLat = (Math.random() - 0.5) * 2 * (randomOffset / 111000);
            const randomLng = (Math.random() - 0.5) * 2 * (randomOffset / (111000 * Math.cos(latlng.lat * Math.PI / 180)));
            
            const adjustedLatlng = L.latLng(
                latlng.lat + randomLat,
                latlng.lng + randomLng
            );
            
            const point = L.circleMarker(adjustedLatlng, {
                radius: pointSize,
                className: 'spray-point',
                fillColor: '#27ae60',
                fillOpacity: 0.6,
                color: '#229954',
                weight: 2
            });
            
            point.addTo(sprayLayer);
            
            const pointData = {
                lat: adjustedLatlng.lat,
                lng: adjustedLatlng.lng,
                radius: radius,
                zoom: map.getZoom()
            };
            
            selectionData.sprayedPoints.push(pointData);
            sprayPointLayers.push(point);
            
            // Add to current session
            if (currentSession !== null) {
                currentSession.push({
                    data: pointData,
                    layer: point
                });
            }
            
            updateDisplay();
        }
        
        function startSpraying() {
            isSpraying = true;
            // Start a new spray session
            currentSession = [];
        }
        
        function stopSpraying() {
            isSpraying = false;
            // Save the completed session
            if (currentSession && currentSession.length > 0) {
                spraySessions.push(currentSession);
                currentSession = null;
                // Enable undo button
                document.getElementById('undoBtn').disabled = false;
            }
        }
        
        map.on('mousedown', function(e) {
            if (!sprayEnabled) return;
            e.originalEvent.preventDefault();
            startSpraying();
            sprayPoint(e.latlng);
        });
        
        map.on('mouseup', stopSpraying);
        
        map.on('mousemove', function(e) {
            if (isSpraying && sprayEnabled) {
                sprayPoint(e.latlng);
            }
        });
        
        map.getContainer().addEventListener('mouseleave', function() {
            if (isSpraying) {
                stopSpraying();
            }
        });
        
        map.on('touchstart', function(e) {
            if (sprayEnabled && e.latlng) {
                startSpraying();
                sprayPoint(e.latlng);
            }
        });
        
        map.on('touchend', stopSpraying);
        
        map.on('touchmove', function(e) {
            if (isSpraying && sprayEnabled && e.latlng) {
                sprayPoint(e.latlng);
            }
        });
        
        map.on('zoomend', function() {
            const radius = getSprayRadius();
            const displayRadius = radius >= 1000 ? 
                (radius / 1000).toFixed(1) + 'km' : 
                radius.toFixed(0) + 'm';
            document.getElementById('sprayRadius').textContent = displayRadius;
            
            updatePermanentLabels();
        });
        
        let stateLabelMarkers = [];
        let countyLabelMarkers = [];
        
        function updatePermanentLabels() {
            const zoom = map.getZoom();
            
            stateLabelMarkers.forEach(marker => map.removeLayer(marker));
            countyLabelMarkers.forEach(marker => map.removeLayer(marker));
            stateLabelMarkers = [];
            countyLabelMarkers = [];
            
            if (zoom >= 6 && stateLayer) {
                stateLayer.eachLayer(function(layer) {
                    const center = layer.getBounds().getCenter();
                    const stateName = layer.feature.properties.name;
                    
                    const label = L.marker(center, {
                        icon: L.divIcon({
                            className: 'permanent-state-label',
                            html: `<div style="
                                font-weight: 600;
                                font-size: ${zoom >= 7 ? '12px' : '10px'};
                                color: #2c3e50;
                                text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;
                                pointer-events: none;
                                white-space: nowrap;
                                text-align: center;
                            ">${stateName}</div>`,
                            iconSize: [100, 20],
                            iconAnchor: [50, 10]
                        }),
                        interactive: false
                    });
                    
                    label.addTo(map);
                    stateLabelMarkers.push(label);
                });
            }
            
            if (zoom >= 8 && countyLayer) {
                countyLayer.eachLayer(function(layer) {
                    const center = layer.getBounds().getCenter();
                    const countyName = layer.feature.properties.NAME || '';
                    
                    if (countyName) {
                        const label = L.marker(center, {
                            icon: L.divIcon({
                                className: 'permanent-county-label',
                                html: `<div style="
                                    font-weight: 500;
                                    font-size: ${zoom >= 9 ? '10px' : '9px'};
                                    color: #34495e;
                                    text-shadow: 0.5px 0.5px 1px white, -0.5px -0.5px 1px white;
                                    pointer-events: none;
                                    white-space: nowrap;
                                    text-align: center;
                                    opacity: ${zoom >= 9 ? '0.9' : '0.7'};
                                ">${countyName}</div>`,
                                iconSize: [80, 16],
                                iconAnchor: [40, 8]
                            }),
                            interactive: false
                        });
                        
                        label.addTo(map);
                        countyLabelMarkers.push(label);
                    }
                });
            }
        }
        
        document.getElementById('sprayToggle').addEventListener('click', function() {
            sprayEnabled = !sprayEnabled;
            
            if (sprayEnabled) {
                // Enable spray mode
                this.classList.add('active');
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary');
                this.textContent = 'Annotation Tool: ON';
                
                map.dragging.disable();
                map.getContainer().classList.add('spray-cursor');
                document.getElementById('sprayInfo').style.display = 'block';
            } else {
                // Disable spray mode - allow navigation
                this.classList.remove('active');
                this.classList.remove('btn-primary');
                this.classList.add('btn-secondary');
                this.textContent = 'Annotation Tool: OFF';
                
                map.dragging.enable();
                map.getContainer().classList.remove('spray-cursor');
                document.getElementById('sprayInfo').style.display = 'none';
                
                // Stop any active spraying
                if (isSpraying) {
                    stopSpraying();
                }
            }
        });
        
        document.getElementById('clearAll').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all selections?')) {
                clearAllSelections();
            }
        });
        
        // Undo functionality
        document.getElementById('undoBtn').addEventListener('click', function() {
            if (spraySessions.length === 0) return;
            
            // Get the last spray session
            const lastSession = spraySessions.pop();
            
            // Remove each point from the last session
            lastSession.forEach(function(point) {
                // Remove from map
                sprayLayer.removeLayer(point.layer);
                
                // Remove from sprayPointLayers array
                const layerIndex = sprayPointLayers.indexOf(point.layer);
                if (layerIndex > -1) {
                    sprayPointLayers.splice(layerIndex, 1);
                }
                
                // Remove from selectionData
                const dataIndex = selectionData.sprayedPoints.findIndex(p => 
                    p.lat === point.data.lat && p.lng === point.data.lng
                );
                if (dataIndex > -1) {
                    selectionData.sprayedPoints.splice(dataIndex, 1);
                }
            });
            
            // Disable undo button if no more sessions
            if (spraySessions.length === 0) {
                this.disabled = true;
            }
            
            updateDisplay();
        });
        
        // Submit button - send data to Qualtrics
        document.getElementById('submitBtn').addEventListener('click', function() {
            const totalSelections = selectionData.sprayedPoints.length;
            
            if (totalSelections === 0) {
                alert('Please mark at least one area before submitting.');
                return;
            }
            
            const dataString = JSON.stringify(selectionData);
            
            if (isEmbedded) {
                // Send data to parent window (Qualtrics)
                window.parent.postMessage({
                    type: 'mapData',
                    data: selectionData,
                    dataString: dataString,
                    totalPoints: totalSelections
                }, '*');
                
                // Show success message
                document.getElementById('successMessage').classList.add('show');
                
                // Optionally disable further editing
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'Selections Submitted ✓';
                document.getElementById('submitBtn').style.background = '#95a5a6';
            } else {
                // Standalone mode - just show alert
                alert('Data ready!\n\nTotal points marked: ' + totalSelections + '\n\nIn Qualtrics, this data will be automatically saved.');
                console.log('Selection data:', selectionData);
            }
        });
        
        // Tutorial functionality
        function closeTutorial() {
            const overlay = document.getElementById('tutorialOverlay');
            overlay.style.animation = 'fadeOut 0.3s';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }
        
        function showTutorial() {
            const overlay = document.getElementById('tutorialOverlay');
            overlay.style.display = 'flex';
            overlay.style.animation = 'fadeIn 0.3s';
        }
        
        document.getElementById('tutorialStart').addEventListener('click', closeTutorial);
        document.getElementById('helpBtn').addEventListener('click', showTutorial);
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize
        loadStates();
        loadCounties();
        updateDisplay();
        
        const radius = getSprayRadius();
        const displayRadius = radius >= 1000 ? 
            (radius / 1000).toFixed(1) + 'km' : 
            radius.toFixed(0) + 'm';
        document.getElementById('sprayRadius').textContent = displayRadius;
    </script>
</body>
</html>
